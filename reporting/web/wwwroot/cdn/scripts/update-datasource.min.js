function showEJ2Spinner(e){ejs.popups.showSpinner($(e)[0])}function hideEJ2Spinner(e){ejs.popups.hideSpinner($(e)[0])}function renderEJ2Textbox(e,t){if(null==e.ej2_instances){new ejs.inputs.TextBox({width:t}).appendTo(e)}}function createEJ2Spinner(e){ejs.popups.createSpinner({target:$(e)[0],cssClass:"e-spin-overlay"})}function renderEJ2Button(e,t){new ejs.buttons.Button({isPrimary:t}).appendTo(e)}let toastInstance,connectorScope,updateDataSourceApp=angular.module("updateDataSourceApp",["ejangular"]);function initializeToastControl(){toastInstance=new ejs.notifications.Toast({title:window.Server.App.LocalizationContent.Success+"!",content:window.Server.App.LocalizationContent.DatasourceUpdateSuccess,target:document.body,cssClass:"e-toast-success",timeOut:1e3,close:function(){toastInstance.toastCloseCb()},position:{X:"Right",Y:"Top"},showCloseButton:!0,newestOnTop:!0,animation:{hide:{effect:"SlideRightOut"},show:{effect:"SlideRightIn"}}}),toastInstance.appendTo(".dc-toast")}function showToast(e){toastInstance.show(),toastInstance.toastCloseCb=e}function closePopup(){parent.$(".ud-iframe").attr("src",""),parent.$(".ud-popup")[0].ej2_instances[0].hide()}function extractXSRFTokenFromCookie(){var e=parent.document.cookie.split("; ").find(e=>e.startsWith("XSRF-TOKEN="));return e?e.split("=")[1]:null}function setXSRFRequestHeader(e){e.setRequestHeader("X-XSRF-TOKEN",extractXSRFTokenFromCookie())}function decodeHtmlAsString(e){var t=document.createElement("textarea");return t.innerHTML=e,t.value}function EscapeHtml(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}updateDataSourceApp.config(["$httpProvider",function(e){e.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",e.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded"}]),updateDataSourceApp.service("ajaxService",["$http","$q",function(e,t){let n,o=!1;return{get:function(r){return o&&n.resolve(),o=!0,n=t.defer(),e({method:"get",url:r,timeout:n.promise}).then(i,a)},postQueryData:function(t,n){return e({method:"post",url:t,data:JSON.stringify(n),headers:{"Content-Type":"application/json"}}).then(i,a)},cancelRequest:function(){o&&n.resolve()}};function a(e){return angular.isObject(e.data)&&e.data.message?t.reject(e.data.message):t.reject(window.Server.App.LocalizationContent.UnknownError)}function i(e){return e.data}}]),$(document).ready(function(){initializeToastControl()}),createEJ2Spinner(".ud-container"),showEJ2Spinner(".ud-container"),updateDataSourceApp.controller("updateDataSourceCtrl",["$scope","ajaxService",function(e,t){e.connectorList=[],e.dataList=[],e.categories=[],e._CryptoAES=window.CryptoJS,e._key=e._CryptoAES.enc.Utf8.parse(keyCode),e._iv=e._CryptoAES.enc.Utf8.parse(ivCode),e.datasourceCallback=function(t){availableDSList=e.sortCollection(t,"name"),e.doAjaxRequest("GET",getDataConnectors,{},$.proxy(e.getConnectionInfo,this))},e.convertTilesInfoFormat=function(e){for(var t=[],n=0;n<e.length;n++){var o=e[n],a=ej.isNullOrUndefined(o.category)?"Rest":o.category;t.push({id:o.id,iconClassName:o.src+"-tile",category:a,itemType:o.itemType,extType:o.extType,displayName:o.name,connector:o.connector,description:o.description})}return t},e.initializeDesigner=function(){var t={serviceUrl:serviceURL,reportServerUrl:serverURL,isAzureApp:isAzureApplication,serviceAuthorizationToken:designerToken,ajaxBeforeLoad:e.ajaxBeforeSend,encryptData:e.encryptData,decryptData:e.decryptData,customBrandSettings:{hideHelpLink:isHideHelpLink,customDomain:customDomain,customBrandName:custombrandName,customLinks:window.customLinks}};designerInstance=new boldReportDesigner($("#updateDesigner"),t)},(getConnectorList=function(){var t=$.proxy(e.datasourceCallback,this);e.initializeDesigner(),designerInstance.getDataConnectorsInfo(t,null)})(),e.getConnectionInfo=function(t){t&&t.status&&t.data&&(connectionList=t.data.connectionList),e.dataList=e.convertTilesInfoFormat(availableDSList),e.connectorList=e.dataList;var n=[];e.connectorList.filter(function(e){n.push(e.category)}),e.selectedDataConnector=Array.prototype.filter.call(e.connectorList,function(e){var t=conString.ConnectionProperties.DataProvider,n=t;return-1!==t.indexOf("_")&&(n=t.split("_")[0]),n.toLowerCase()===e.extType.toLowerCase()})[0],hideEJ2Spinner(".ud-container"),e.$apply()},e.doAjaxRequest=function(t,n,o,a){$.ajax({type:t,url:n,data:o,beforeSend:function(t){t.setRequestHeader("ServerUrl",serverURL),t.setRequestHeader("serviceAuthorizationToken",designerToken),e._setRequestHeader(t)},success:function(e){e&&ej.ReportUtil.invokeCallBack(a,e)},error:function(){ej.ReportUtil.invokeCallBack(a,null)}})},e.sortCollection=function(e,t){return e.sort(function(e,n){return e[t]<n[t]?-1:e[t]>n[t]?1:0})},e._encryptData=function(t){return e._CryptoAES.AES.encrypt(e._CryptoAES.enc.Utf8.parse(t),_key,{keySize:16,iv:_iv,mode:e._CryptoAES.mode.CBC,padding:e._CryptoAES.pad.Pkcs7}).toString()},e._decryptData=function(t){return e._CryptoAES.AES.decrypt(t,_key,{keySize:16,iv:_iv,mode:e._CryptoAES.mode.CBC,padding:e._CryptoAES.pad.Pkcs7}).toString(e._CryptoAES.enc.Utf8)},e.encryptData=function(t){t&&t.data&&(t.data=e._encryptData(t.data))},e.decryptData=function(t){t&&t.data&&(t.data=e._decryptData(t.data))},e._injectKeys=function(e){e&&e.headers&&e.headers.push({Key:"encryptionKey",Value:encryptionKey})},e._setRequestHeader=function(e){e&&e.setRequestHeader("encryptionKey",encryptionKey)},e.ajaxBeforeSend=function(t){e._injectKeys(t)}}]),updateDataSourceApp.controller("connectDataHeaderCtrl",["$scope",function(e){e.onCloseBtnClick=function(){closePopup()}}]),updateDataSourceApp.controller("connectorCtrl",["$scope","ajaxService",function(e,t){connectorScope=e,e.isCustomExtension="e-custom"===e.selectedDataConnector.itemType,angular.element(".dc-header").text(e.selectedDataConnector.displayName);let n=new ejs.popups.Tooltip({content:"valudescription",target:".dc-description-img",position:"RightBottom",offsetY:-10,cssClass:"e-rpt-label-tooltip",windowCollision:!0,animation:{open:{effect:"FadeIn",duration:500,delay:0},close:{effect:"FadeOut",duration:500,delay:0}}});n.beforeOpen=function(t){n.content="Connect To "+e.selectedDataConnector.description,n.dataBind()},n.appendTo(angular.element(".dc-header-container")[0]),e.updateDataContainerHeight=function(){angular.element(".dc-container").css("height",window.innerHeight-angular.element(".ud-header-container").height()-angular.element(".ud-footer-container").height())},e.updateDesignerContainerHeight=function(){return window.innerHeight-(angular.element(".data-designer-container")[0].getBoundingClientRect().top-angular.element(".ud-header-container")[0].getBoundingClientRect().top)-angular.element(".ud-footer-container").height()-24},angular.element(".data-designer-container").css("height",e.updateDesignerContainerHeight()),window.addEventListener("resize",e.updateDataContainerHeight),e.resizeTO=void 0,e.reportDataExtensions=dataExtensions,e._CryptoAES=window.CryptoJS,e._key=e._CryptoAES.enc.Utf8.parse(keyCode),e._iv=e._CryptoAES.enc.Utf8.parse(ivCode),e.onAjaxBeforeLoad=function(e){e&&e.headers&&e.headers.push({Key:"encryptionKey",Value:encryptionKey})},e.encryptData=function(t){t&&t.data&&(t.data=e._CryptoAES.AES.encrypt(e._CryptoAES.enc.Utf8.parse(t.data),e._key,{keySize:16,iv:e._iv,mode:e._CryptoAES.mode.CBC,padding:e._CryptoAES.pad.Pkcs7}).toString())},e.decryptData=function(t){t&&t.data&&(t.data=e._CryptoAES.AES.decrypt(t.data,e._key,{keySize:16,iv:e._iv,mode:e._CryptoAES.mode.CBC,padding:e._CryptoAES.pad.Pkcs7}).toString(e._CryptoAES.enc.Utf8))},e.onDesignerCreate=function(){this.model.filterDataConnectors=window.connectionList,this.dataExtensions=designerInstance.dataExtensions,this.builtInExts=designerInstance.builtInExts,this.isOnPremiseMode=window.isSelfHosted,e.isCustomExtension&&(this.dataExtensions=[e.selectedDataConnector.extType]),this.dataSource.renderContainer($(".dataContainer")),e.renderDescription.call(this),this.dataSource.configTable.data("selected",e.selectedDataConnector.itemType),this.dataSource.configTable.data("selectedExt",e.selectedDataConnector.extType),$("#dataDesigner_datasource_dsname").val(decodeHtmlAsString(dataSourceDetail.Name)),$("#dataDesigner_datasource_descname").val(decodeHtmlAsString(dataSourceDetail.Description)),this.dataSource.editData(conString.ConnectionProperties.DataProvider,conString);let t=e.isCustomExtension?this.extensiondataSource:this.dataSource;t.validateConnection=function(t,n){$(".dataContainer").find(".e-rptdesigner-error").length||(e.isCustomExtension?e.connectionResult(t,n,this):e.connectionResult(this.constructCon(),t,this))},t.showIndicator=function(){showEJ2Spinner(".ud-container")},t.hideIndicator=function(){hideEJ2Spinner(".ud-container")}},e.renderDescription=function(){let e=this._id+"_datasource_descname";this.dataSource.renderTextArea(window.Server.App.LocalizationContent.Description,e,$("table.e-rptdesigner-dsconfig-table")),$("#"+e).attr("maxlength",1024),$("#"+e+"_td").append('<div class="descname-info">* '+window.Server.App.LocalizationContent.MaxNoOfCharacters+"</div>")},e.testConnection=function(t){e.dataDesigner.dataSource.connectionCallBack=t,e.dataDesigner.dataSource.connectDatasource()},e.showValidationMsg=function(e,t,n){let o=$("#"+e+"_error_icon_td"),a=$("#"+e+"_td").find(".e-designer-content-label");t?(ej.ReportUtil.showErrIndictor(o,!0,n),a.addClass("e-rptdesigner-error")):(ej.ReportUtil.showErrIndictor(o,!1),a.removeClass("e-rptdesigner-error"))},e.updateDataSource=function(n){let o={Name:$("#dataDesigner_datasource_dsname").val(),Description:$("#dataDesigner_datasource_descname").val(),IsNameChanged:$("#dataDesigner_datasource_dsname").val()!==dataSourceDetail.Name,IsDescriptionChanged:$("#dataDesigner_datasource_descname").val()!==dataSourceDetail.Description,Id:dataSourceDetail.Id};t.postQueryData(updateURL,{conString:JSON.stringify(n),dataSourceDetail:JSON.stringify(o)}).then(function(t){hideEJ2Spinner(".ud-container"),t.error?e.dataDesigner.getInstance("ReportUtil").ejAlertDialog(window.Server.App.LocalizationContent.DataConnector,t.error,!1,!0,!1,window.Server.App.LocalizationContent.DataFailure):t.result.IsNameExist?e.showValidationMsg("dataDesigner_datasource_dsname",!0,window.Server.App.LocalizationContent.IsDataSourceExist):(e.dataSourceName=n.Name,e.dataDesigner.dataSource.connectionCallBack())})},e.getEmbeddedData=function(e){if(e.ConnectionProperties){let t={};return e.ConnectionProperties.EmbeddedData&&(t.ConcEmbeddedData=e.ConnectionProperties.EmbeddedData),e.ConnectionProperties.SSHConnectionSettings&&e.ConnectionProperties.SSHConnectionSettings.EmbeddedData&&(t.SSHConcEmbeddedData=e.ConnectionProperties.SSHConnectionSettings.EmbeddedData),e.ConnectionProperties.SSLConnectionSettings&&e.ConnectionProperties.SSLConnectionSettings.EmbeddedData&&(t.SSLConcEmbeddedData=e.ConnectionProperties.SSLConnectionSettings.EmbeddedData),t}return null},e.setEmbeddedData=function(e,t){t&&Object.keys(t).length>0&&e.ConnectionProperties&&(t.ConcEmbeddedData&&e.ConnectionProperties.EmbeddedData&&(e.ConnectionProperties.EmbeddedData.Data=t.ConcEmbeddedData),t.SSHConcEmbeddedData&&e.ConnectionProperties.SSHConnectionSettings&&e.ConnectionProperties.SSHConnectionSettings.EmbeddedData&&(e.ConnectionProperties.SSHConnectionSettings.EmbeddedData.Data=t.SSHConcEmbeddedData),t.SSLConcEmbeddedData&&e.ConnectionProperties.SSLConnectionSettings&&e.ConnectionProperties.SSLConnectionSettings.EmbeddedData&&(e.ConnectionProperties.SSLConnectionSettings.EmbeddedData.Data=t.SSLConcEmbeddedData))},e.connectionResult=function(t,n,o){if("true"===n){showEJ2Spinner(".ud-container");let n=e.getEmbeddedData(t);n&&Object.keys(n).length>0?e.dataDesigner.getInstance("ReportUtil").doAjaxPost("POST",ej.ReportUtil.getTenantUrl(e.dataDesigner.model.serviceUrl+"/PostDesignerAction/",e.dataDesigner.model.tenantName),{action:"EmbeddedData",data:JSON.stringify({designerAction:"EmbeddedData",embeddedDataInfo:n})},{fnction:n=>{"string"==typeof n&&-1!==n.indexOf("Sf_Exception")?e.dataDesigner.getInstance("ReportUtil").ejAlertDialog(window.Server.App.LocalizationContent.DataConnector,n,!1,!0,!1,window.Server.App.LocalizationContent.EmbeddeddDataFailure):(e.setEmbeddedData(t,n),e.updateDataSource(t))},indicator:[null,null]}):e.updateDataSource(t)}else o.reportDesigner.getInstance("ReportUtil").ejAlertDialog(o.getLocale("alertLabel"),n,!1,!0,!1,o.getLocale("alertConnectionFailed"),{})},e.$on("$destroy",function(){window.removeEventListener("resize",e.updateDataContainerHeight)})}]),updateDataSourceApp.controller("connectDataFooterCtrl",["$scope",function(e){e.onUpdateBtnClick=function(){connectorScope.testConnection(function(){showToast(function(){parent.location.reload()})})}}]),renderEJ2Button(angular.element(".ud-footer-update-btn")[0],!0),$.ajaxSetup({beforeSend:function(e){setXSRFRequestHeader(e)}});
