var cursorPos,Paste,createHiddenEditable,isFocusable,initialLine,initialPosition,targetElement,itemId,dataManger,elementNode,getAllCommentAjax,deletedCommentId,dashboardTypeId="#sync_report_viewer",parentRefUrl=window.location!=window.parent.location?document.referrer:document.location.href.replace(document.location.pathname+document.location.search,"");if(""==parentRefUrl)var parentUrl="";else parentUrl=parentRefUrl.match(/:\/\/(.[^/]+)/)[1];var iframeRefUrl=window.location.href,iframeUrl=iframeRefUrl.match(/:\/\/(.[^/]+)/)[1],commentAction={Add:0,Edit:1,Delete:2,GetComments:3},date=new Date;function GetAllComments(e,t,a,n){var o={orderBy:n,skip:0,take:0,itemType:t,itemId:e,dashboardItemId:a,commentAction:commentAction.GetComments,parentDashboardId:parentDashboardId};showWaitingPopup("parent-scroll-element"),getAllCommentAjax=parent.ajaxPostCall("POST",getAllCommentsUrl,o,null,getCommentsResult,null,completeCommentResult)}function completeCommentResult(e){$(".post-message > p > img").on("load",function(){refreshCommentScroller()}),generateProfileAvatar()}function getCommentsResult(e){if(e){if(1==e.Status){$(".view-heading").css("display","block"),parent.$("#commentModuleContainer").hasClass("displayNone")?$($(".header-section a")[0]).css("display","none"):($($(".header-section a")[0]).css("display","block"),parent.$("#widget-loader-icon").hide());var t=ConstructTree(e.Comments,null);$(".comment-list").html(t),$(".comment-list").find(".post").find(".post").find(".children").addClass("no-left-padding"),$("#comment_count").text(e.ActiveCommentsCount),0==e.ActiveCommentsCount&&($("#comment_action_slider").click(),$(".additional-content").html("<h7>"+window.Server.App.LocalizationContent.NoComments+"</h7>")),$('[data-bs-toggle="tooltip"]').tooltip(),hideWaitingPopup("parent-scroll-element"),$("body").removeClass("displayNone"),refreshCommentScroller();document.URL;if(parent.document.URL.indexOf("comment=")>-1){var a="#comment-"+getUrlVars(parent.document.URL.split("#")[0]).comment;if($(a).find("span.time-ago:first").click(),$(a).find(".post-content:first").css({"background-color":"#F4E4AE"}),parent.document.URL.indexOf("isreply=true")>-1&&$(a).find(".reply-comment").first().click(),i_am_ie9){$(a).find(".post-content:first").css("backgroundColor","hsl(46,76%,82%");for(var n=3e3,o=82;o<=100;o+=.1)(function(e,t){setTimeout(function(){$(a).find(".post-content:first").css("backgroundColor","hsl(46,76%,"+e+"%)")},t)})(o,n+=10)}else setTimeout(function(){$(a).find(".post-content:first").css({transition:"background-color 10s ease-in-out","background-color":"inherit"})},40),setTimeout(function(){$(a).find(".post-content:first").attr("style","")},7e3)}addTarget_blank()}else hideWaitingPopup("parent-scroll-element");-1==parent.document.URL.indexOf("comment=")&&refreshCommentScroller()}}function refreshCommentScroller(){var e;if(e=$("#comment_action_area").hasClass("isHide")?$("#comment_submit_container").outerHeight():$("#comment_action_area").outerHeight(),"true"!=$("#isWidgetComment").val()){parent.$("#comment-module-container-loader-icon").hide(),$("#scroll-element").children().addClass("e-content");var t=parent.$("#commentModuleContainer").height()-(e+$(".count-sort").outerHeight()+$(".header-section").outerHeight()),a=parent.$("#commentModuleContainer").width()-2;$("#scroll-element").ejScroller({height:t,width:a,scrollerSize:7,buttonSize:0,enableTouchScroll:"false"!==parent.$("#is_mobile").val()});var n=$("#scroll-element").ejScroller("instance");n.model.height=t,n.refresh()}}function ConstructTree(e,t){generateProfileAvatar();var a="";if(null!=e)for(var n=0;n<e.length;n++){var o=0;if(e[n].Replies.length>0)for(var i=0;i<e[n].Replies.length;i++)e[n].Replies[i].IsActive&&(o+=1);e[n].IsActive?(a+="<li id='comment-"+e[n].Id+"'data-comment-id='"+e[n].Id+"' class='post'><div class='post-content'><div class='avatar-container'> <div class='user' data-userid='"+e[n].UserId+"'><div class='profile-pic-tag avatar' data-id='"+e[n].IdPReferenceId+"' data-type='user' data-display-name='"+e[n].UserDisplayName+"' data-image-size='32'  data-bs-toggle='tooltip' title='"+e[n].UserDisplayName+"' data-bs-placement='bottom'></div></div></div><div class='post-body'> <header><span class='post-byline col-5 no-padding'><span title='"+e[n].UserDisplayName+"'class='author publisher-anchor-color'>"+e[n].UserDisplayName+"</span></span><menu>",a+="<li class='reply' title='"+window.Server.App.LocalizationContent.ReplyButton+"'  data-bs-toggle='tooltip' data-bs-placement='bottom'> <a class='reply-comment'><span class='su su-reply'></span> </a></li>","true"!=$("#isadmin").text().toLowerCase()&&e[n].UserId!=$("#userName").val()&&null===t||(a+="<span class='dropdown-toggle option-icon' title='"+window.Server.App.LocalizationContent.Action+"' data-bs-toggle='dropdown'><span class='su su-options-horizontal'></span></span><ul class='dropdown-menu' role='menu'>",e[n].UserId==$("#userName").val()&&(a+="<li class='edit' title='"+window.Server.App.LocalizationContent.EditButton+"'  data-bs-toggle='tooltip' data-bs-placement='top'> <a class='edit-comment'><span>"+window.Server.App.LocalizationContent.EditButton+"</span> </a></li>"),"true"!=$("#isadmin").text().toLowerCase()&&e[n].UserId!=$("#userName").val()||(a+="<li class='delete' title='"+window.Server.App.LocalizationContent.Delete+"'  data-bs-toggle='tooltip' data-bs-placement='top'> <a class='delete-comment'><span>"+window.Server.App.LocalizationContent.Delete+"</span> </a></li>"),null!=t&&(a+="<li class='parent' data-parent-id='"+t.Id+"' title='"+window.Server.App.LocalizationContent.Replied+" "+t.UserDisplayName+"'  data-bs-toggle='tooltip' data-bs-placement='top'> <a class='parent-name'><span>"+window.Server.App.LocalizationContent.ShowParent+"</span> </a></li></ul>")),a+="</menu><span class='post-meta col-9 no-padding'><a "+commentPermalinkHelper(e[n].Id)+" class='permalink'><span class='time-ago' title='"+e[n].Id+"'class='permalink'><span class='time-ago' title='"+e[n].CreatedDateString+" - "+e[n].TimeZoneName+"'data-html='false'  data-bs-toggle='tooltip' data-bs-placement='right'>"+e[n].TimeAgo+"</span></a></span> </header> <div class='post-body-inner'><div class='edit-post displayNone'></div><div class='post-message'>"+SplitUserDisplayName(SanitizeHtml(customMarkdownParser(e[n].MarkdownComment)),SanitizeHtml(e[n].MarkdownComment))+"</div><div class='markDownComment d-none'>"+SanitizeHtml(e[n].MarkdownComment)+"</div> </div></div><div class='reply-form-container displayNone'></div><div class='col-12 reply-count "+(o>0?"hasChild":"")+"'><div class='col-6 child-count'><span class='count-text'>"+o+"</span><span class='count-label'>"+(1!=o?window.Server.App.LocalizationContent.Replies:window.Server.App.LocalizationContent.ReplyMessage)+"</span></div><div class='col-6 no-padding collapse-icon-container'><span class='su ",a+=o>0?"su-vertical-collapse collapse-icon' title='"+window.Server.App.LocalizationContent.Collapse+"'></span>":"collapse-icon' data-bs-toggle='collapse'></span>",a+="</div></div></div><ul class='children'>"):(a+="<li id='comment-"+e[n].Id+"'data-comment-id='"+e[n].Id+"' class='post'><div class='post-content'><div class='avatar-container'><div class='profile-pic-tag avatar' data-id='"+e[n].IdPReferenceId+"' data-type='user' data-display-name='"+e[n].UserDisplayName+"' data-image-size='32'></div></div><div class='post-body'> <header><span class='post-byline col-5 no-padding'></span><span class='post-meta col-9 hidden no-padding'><a "+commentPermalinkHelper(e[n].Id)+" class='permalink'><span class='time-ago' title='"+e[n].CreatedDateString+" - "+e[n].TimeZoneName+"'data-html='false'  data-bs-toggle='tooltip' data-bs-placement='right'>"+e[n].TimeAgo+"</span></a></span><menu class='deleted-post'><li class='reply' > <span class='su su-reply'></span> </li><span class='dropdown-toggle option-icon' ><span class='su su-options-horizontal'></span></span></menu></header> <div class='post-body-inner'><div class='post-message deleted-message'><span class='su su-warning'></span><span>"+window.Server.App.LocalizationContent.DeletedMessage+"</span></div> </div></div><div class='col-12 reply-count "+(o>0?"hasChild":"")+"'><div class='col-6 child-count'><span class='count-text'>"+o+"</span><span class='count-label'>"+(1!=o?window.Server.App.LocalizationContent.Replies:window.Server.App.LocalizationContent.ReplyMessage)+"</span></div><div class='col-6 no-padding'>",o>0&&(a+="<span class='su su-vertical-collapse collapse-icon' data-bs-toggle='collapse'</span>"),a+="</div></div></div><ul class='children'>"),e[n].Replies.length>0?a+=ConstructTree(e[n].Replies,e[n])+"</ul> </li>":a+="</ul> </li>"}return a}function customMarkdownParser(e){var t=[],a=[],n=[],o=/(?:\@\ (.*?) )/g,i=$("#itemType").attr("data-item-type").toLowerCase().replace(/\b[a-z]/g,function(e){return e.toUpperCase()}),s=new EasyMDE({element:$("#temp")[0],spellChecker:!1,autoDownloadFontAwesome:!1}),r=e;if(null!=(t=r.match(/(?:\@ (\[.*?\]) )/g))){t=jQuery.unique(t);for(var l=0;l<t.length;l++){var c=SplitUserDisplayName(t[l],t[l]);r=r.replace(t[l],"<span class='cm-usercontainer'>"+c+"</span>")}}if(null!=(a=r.match(o))){a=jQuery.unique(r.match(o));for(l=0;l<a.length;l++){var p=new RegExp(a[l],"g");r=r.replace(p,"<span class='cm-groupcontainer'>"+a[l]+"</span>")}}if(null!=(n=r.match(/(@all)/g))){n=jQuery.unique(n);for(l=0;l<n.length;l++){p=new RegExp(n[l],"g");r=r.replace(n[l],"<span class='cm-allcontainer'>"+n[l]+"</span>")}}r=s.options.previewRender(r);for(var d=$("<div></div>").html(r),m=$(d).find("a"),u=0;u<m.length;u++)m[u].setAttribute("target","_blank");var h=$(d).find("img");for(u=0;u<h.length;u++)if(h[u].setAttribute("target","_blank"),-1!==h[u].src.indexOf("image-")){var g=h[u].src.split("/");for(l=0;l<g.length;l++)-1!==g[l].indexOf("image-")&&(h[u].src=rootUrl+"/content/images/commentimages/"+i+"/"+itemId+"/"+g[l])}return r=$(d).html()}function renderMde(e){var t=new EasyMDE({element:$(e)[0],status:!1,spellChecker:!1,autoDownloadFontAwesome:!1,toolbar:[{name:"bold",action:EasyMDE.toggleBold,className:"su su-bold",title:window.Server.App.LocalizationContent.Bold},{name:"italic",action:EasyMDE.toggleItalic,className:"su su-italic",title:window.Server.App.LocalizationContent.Italic},{name:"heading",action:EasyMDE.toggleHeadingSmaller,className:"su su-header",title:window.Server.App.LocalizationContent.Heading},"|",{name:"quote",action:EasyMDE.toggleBlockquote,className:"su su-quote",title:window.Server.App.LocalizationContent.Quote},{name:"unordered-list",action:EasyMDE.toggleUnorderedList,className:"su su-list-ul",title:window.Server.App.LocalizationContent.Generic},{name:"ordered-list",action:EasyMDE.toggleOrderedList,className:"su su-list-ol",title:window.Server.App.LocalizationContent.Number},"|",{name:"link",action:EasyMDE.drawLink,className:"su su-link",title:window.Server.App.LocalizationContent.Link},{name:"image",action:EasyMDE.drawImage,className:"su su-image",title:window.Server.App.LocalizationContent.Image},{name:"uploadImage",className:"su su-upload-image",title:window.Server.App.LocalizationContent.UploadImage},{name:"preview",action:EasyMDE.togglePreview,className:"su su-preview no-disable",title:window.Server.App.LocalizationContent.Preview}],previewRender:function(e){return customMarkdownParser(e)}});return"comment-image-file"==$(".su-upload-image").attr("id")?$(".su-upload-image").attr("id","comment-image-edit-file"):$(".su-upload-image").attr("id","comment-image-file"),t}function getUrlVars(e){var t={};e.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(e,a,n){t[a]=n});return t}function addTarget_blank(){$("ul#commentList li .post-message").find("a").attr("target","_blank")}function truncateUrl(){var e=parent.window.location.href.split("#")[0],t=e.indexOf("?comment="),a=e.indexOf("&comment="),n=e.substr(0,e.indexOf("/reports")+1);return n.length>0&&(e=e.replace(n,"/")),t>0?e=e.slice(0,e.lastIndexOf("?comment=")):a>0&&(e=e.slice(0,e.lastIndexOf("&comment="))),e}function getRelativePath(e){var t=$("#itemType").attr("data-item-type").toLowerCase().replace(/\b[a-z]/g,function(e){return e.toUpperCase()}),a=e.match(/(?:\!\[\]\((.*?)\))/g),n=[];if(null!=a){for(var o=0;o<a.length;o++)n[o]=a[o].split(/[\(\\!\[\ \]\\)\s]+/),n[o]=$.grep(n[o],function(e){return e});for(var i="",s=0;s<n.length;s++)n[s]=n[s].toString(),-1!==n[s].indexOf("image-")&&""!=(i=rootUrl+"/content/images/commentimages/"+t+"/"+itemId+"/"+n[s])&&(n[s]="![]("+n[s]+")",i="![]("+i+")",e=e.replace(n[s],i))}return e}function pasteImageReader(e){var t=e,a=$("#itemType").attr("data-item-type").toLowerCase().replace(/\b[a-z]/g,function(e){return e.toUpperCase()}),n={DataUrl:t,itemId:itemId,itemType:a,parentDashboardId:parentDashboardId};parent.ajaxPostCall("POST",commentImageUrl,n,null,pasteCommentImages,null,null)}function pasteCommentImages(e){if(""!==e&&-1!==e.indexOf("image-")){var t=" ![]("+e+")";cursorPos.codemirror.replaceSelection(t),hideWaitingPopup("parent-scroll-element")}else hideWaitingPopup("parent-scroll-element")}function autoCompletes(e,t){var a=function(e){return window.event?e.keyCode:e.which?e.which:void 0}(e);if(38===a)(n=jQuery.Event("keydown")).keyCode=38,n.which=38,$("#autocomplete-input").trigger(n);else if(40===a){var n;(n=jQuery.Event("keydown")).keyCode=40,n.which=40,$("#autocomplete-input").trigger(n)}else if(13===a){e.preventDefault();$("ul.e-ul li.e-hover").attr("id")}else autoCompleteRefresh(t),$("#autocomplete-input").val(t),$("#autocomplete-input").ejAutocomplete("enable"),$("#autocomplete-input").ejAutocomplete("search"),$("#autocomplete-input").ejAutocomplete("hide")}function getCaretCharacterOffsetWithin(e){var t,a=0,n=e.ownerDocument||e.document,o=n.defaultView||n.parentWindow;if(void 0!==o.getSelection){if((t=o.getSelection()).rangeCount>0){var i=o.getSelection().getRangeAt(0),s=i.cloneRange();s.selectNodeContents(e),s.setEnd(i.endContainer,i.endOffset),a=s.toString().length}}else if((t=n.selection)&&"Control"!=t.type){var r=t.createRange(),l=n.body.createTextRange();l.moveToElementText(e),l.setEndPoint("EndToEnd",r),a=l.text.length}return a}function onSelect(e){var t;$("#scroll-element").ejScroller("enable");var a,n=$("ul.e-ul li.e-hover").attr("id");""!=n&&null!=n&&null!=n&&(""!=(a=n.split("-"))&&null!=a&&null!=a&&(t=a[0],n.split(/-(.+)?/)[1]));var o=initialPosition.line,i=initialPosition.ch,s=initialLine.length;targetElement.focus(),cursorPos.codemirror.setSelection({line:o,ch:0},{line:o,ch:s}),cursorPos.codemirror.replaceSelection(initialLine),cursorPos.codemirror.setSelection({line:o,ch:i},{line:o,ch:i}),"User"==t?cursorPos.codemirror.replaceSelection("@ ["+e.item.Name+"|~"+e.item.IdPReferenceId+"] "):cursorPos.codemirror.replaceSelection("@ "+e.value+" "),$("#autocomplete-input").ejAutocomplete("disable"),$("#autocomplete-input_suggestion").attr("style","display:none !important;")}function onOpen(){var e=$("#autocomplete-input").data("ejAutocomplete").scrollerObj;e.model.height=135,e.model.buttonSize=0,e.model.scrollerSize=9,e.refresh(),$("#autocomplete-input_suggestion").attr("style","display:block !important; z-index: 9;");var t=document.getElementById("autocomplete");if($(t).length){var a=$(t)[0].getBoundingClientRect(),n=a.left,o=a.top+30,i=$("#autocomplete-input_suggestion").width();$("#autocomplete-input_suggestion").height(),$(parent.$("#commentModuleContainer")[0]).height(),$(parent.$("#commentModuleContainer")[0]).width()>n+i?$("#autocomplete-input_suggestion").css("left",n):$("#autocomplete-input_suggestion").css("left",n-i+16);$("#autocomplete-input_suggestion").css("top",o),$("#autocomplete-input_suggestion").addClass("usermention-suggestionlist")}}function autoCompleteRefresh(e){var t=e;clearTimeout(window.timer),window.timer=setTimeout(function(){autosuggestion(t)},400)}function autosuggestion(e){$.xhrPool.abortAll();var t=parent.$("#dashboard_Comment").attr("data-item-id");if($("#autocomplete-input_suggestion").css("display","none"),""!=e.trim()){var a={searchWord:e,itemId:t,parentDashboardId:parent.$("#isMultiDashboard").attr("data-parent-id")};parent.ajaxPostCall("GET",userMentionDataSourceUrl,a,null,userMentionDataList,null,null)}}function userMentionDataList(e){$("#autocomplete-input_suggestion").css("display","none");var t=$("#autocomplete-input").data("ejAutocomplete");t.model.dataSource=JSON.parse(e),t._OnTextEnter(),onOpen()}function splitUserMention(e){var t=$(e).children().find(".CodeMirror-code"),a=!1,n=[],o=[],s=[],r=[],l=[],c=/(?:\@ (.*?) )/,p=/(?:\@\ (.*?) )/,d=$(t)[0].getElementsByClassName("cm-usercontainer"),m=$(t)[0].getElementsByClassName("cm-groupcontainer"),u=$(t)[0].getElementsByClassName("cm-allcontainer");if(d.length)for(i=0;i<d.length;i++)s[i]=c.exec(d[i].textContent),s[i]&&n.push(s[i][1].replaceAll("[","").replaceAll("]",""));if(m.length)for(i=0;i<m.length;i++)s[i]=p.exec(m[i].textContent),s[i]&&o.push(s[i][1]);return u.length?a=!0:($.each(n,function(e,t){-1===$.inArray(t,r)&&r.push(t)}),$.each(o,function(e,t){-1===$.inArray(t,l)&&l.push(t)})),{uniqueUsersValue:r,uniqueGroupValue:l,mentionedAll:a}}function userMentionInitializing(e,t){var a=e.target,n=e.keyCode?e.keyCode:e.which;cursorPos.value();if(64===n&&(targetElement=a,0==$("#autocomplete-trigger").length)){var o='<span id="autocomplete"><span id="autocomplete-trigger">@</span><span id="autocomplete-search-text" contenteditable></span></span>';cursorPos.codemirrorIgnore;var i=cursorPos.codemirror.getCursor();initialPosition=i;var s=i.line,r=i.ch,l=cursorPos.codemirror.getLine(s);initialLine=l;var c=l.length,p="",d=cursorPos.codemirror.findWordAt({line:s,ch:r}).anchor.ch,m=cursorPos.codemirror.findWordAt({line:s,ch:r}).head.ch;if(d==m-1&&c==r||0==d&&0==m||" "==l[r-1]&&null==l[r])(u=$(t).children().find(".CodeMirror-code").children())&&($(u[s].firstChild).append(o),p=$("#autocomplete-search-text"),$(p[0]).focus()),e.preventDefault(),$("#scroll-element").ejScroller("disable");else if(r==d||" "==l[r-1]&&(" "==l[r+1]||" "==l[r])){cursorPos.codemirror.setSelection({line:s,ch:r},{line:s,ch:c});var u,h=cursorPos.codemirror.getSelection();if(cursorPos.codemirror.replaceSelection(""),u=$(t).children().find(".CodeMirror-code").children()){var g=u[s].firstChild;$(g).append(o),g.append(h),p=$("#autocomplete-search-text"),$(p[0]).focus()}e.preventDefault(),$("#scroll-element").ejScroller("disable")}$("#autocomplete-search-text").on("keydown",function(e){var t=e.keyCode?e.keyCode:e.which,n=$("#autocomplete-search-text").text(),o=getCaretCharacterOffsetWithin(document.getElementById("autocomplete-search-text"));8===t&&0==o&&($("#autocomplete-input_suggestion").css("display","none"),removingUserMentionContainer(a,n,s,r,c,l))}),$("#autocomplete-search-text").on("blur",function(e){$("#scroll-element").ejScroller("enable")}),$("#autocomplete-search-text").on("keyup",function(e){var t=e.keyCode?e.keyCode:e.which;$("#scroll-element").ejScroller("enable");var n=$("#autocomplete-search-text").text();getCaretCharacterOffsetWithin(document.getElementById("autocomplete-search-text"));if(27===t||33===t||9===t||36===t)removingUserMentionContainer(a,n,s,r,c,l);else if(13===t){e.preventDefault();var o=$("ul.e-ul li.e-hover").attr("id"),i=$("ul.e-ul li.e-hover").text();if(""!=i&&"No suggestions"!=i)onSelect({id:o,value:i});else removingUserMentionContainer(a,n,s,r,c,l)}else if(38!=t&&40!=t)autoCompletes(e,n);else autoCompletes(e,n)}),$(".CodeMirror").on("click",function(){var e="";$("#autocomplete-search-text").length&&$("#autocomplete").length&&(e=(e="@"+$("#autocomplete-search-text").text()).trim(),a.focus(),cursorPos.codemirror.setSelection({line:initialPosition.line,ch:0},{line:initialPosition.line,ch:initialLine.length}),cursorPos.codemirror.replaceSelection(initialLine),cursorPos.codemirror.setSelection({line:initialPosition.line,ch:initialPosition.ch},{line:initialPosition.line,ch:initialPosition.ch}),cursorPos.codemirror.replaceSelection(e),$("#autocomplete-input").ejAutocomplete("disable"),$("#autocomplete-input_suggestion").attr("style","display:none !important;"))})}}function displaySuggestionList(){$("#autocomplete-input_suggestion").css("display","none")}function removingUserMentionContainer(e,t,a,n,o,i){$("#scroll-element").ejScroller("enable");var s="";$("#autocomplete-search-text").length&&$("#autocomplete").length&&(s=(s="@"+t).trim(),$("#autocomplete-input").ejAutocomplete("disable"),$("#autocomplete-input_suggestion").attr("style","display:none !important;"),e.focus(),cursorPos.codemirror.setSelection({line:a,ch:0},{line:a,ch:o}),cursorPos.codemirror.replaceSelection(i),cursorPos.codemirror.setSelection({line:a,ch:n},{line:a,ch:n}),cursorPos.codemirror.replaceSelection(s),$("#autocomplete-input").ejAutocomplete("disable"),$("#autocomplete-input_suggestion").attr("style","display:none !important;"))}function closeComments(){$(".view-heading").css("display","none"),$(".header-section a").css("display","none"),parent.$("#commentImage_popup").ejDialog("close"),parent.$("#commentModuleContainer").addClass("displayNone"),parent.$("#delete_popup_iframe").addClass("displayNone"),parent.$("#dashboard-comment").removeClass(" highlight-icon"),parent.$("#widgetCommentModuleContainer").addClass("displayNone"),"true"==parent.$("#is_mobile").val()&&(parent.$(dashboardTypeId).show(),parent.$("#server-mobile-navbar .server-comment").hasClass("active")&&(parent.$("#server-mobile-navbar a.active").removeClass("active"),parent.$("#server-mobile-navbar .su-nav-dashboard").addClass("active"))),parent.$(".options").css("right","0px"),parent.$(".options li").removeClass("active"),iframeUrl==parentUrl?parent.$(dashboardTypeId).css("width",$(parent.window).width()):parent.$(".su-sidebar-collapse").is(":visible")||(parent.$(dashboardTypeId).css("width",parent.document.body.clientWidth-40),$(parent.parent.document.body).find("#item-viewer").css("width",parent.document.body.clientWidth-5))}function ajaxSetup(){$.xhrPool=[],$.xhrPool.abortAll=function(){$(this).each(function(e,t){t.abort()}),$.xhrPool.length=0},$.ajaxSetup({beforeSend:function(e){$.xhrPool.push(e)},complete:function(e){var t=$.xhrPool.indexOf(e);t>-1&&$.xhrPool.splice(t,1)}})}function commentPermalinkHelper(e){return"href='#comment-"+e+"'"}function SplitUserDisplayName(e,t){var a=/\[|\]\\|\|\~.*?]/g,n=t.match(/(?:\@ (.*?) )/g);return null!=n&&$.each(n,function(t,n){var o=n.replace(a,"");e=e.replace(n,o)}),e}function SanitizeHtml(e){return e.replace(/<\s*script[^>]*>/gi,"").replace(/<\s*\/\s*script\s*>/gi,"")}function extractXSRFTokenFromCookie(){var e=parent.document.cookie.split("; ").find(e=>e.startsWith("XSRF-TOKEN="));return e?e.split("=")[1]:null}function setXSRFRequestHeader(e){e.setRequestHeader("X-XSRF-TOKEN",extractXSRFTokenFromCookie())}function decodeHtmlAsString(e){var t=document.createElement("textarea");return t.innerHTML=e,t.value}function EscapeHtml(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}$(document).ready(function(){dataManager=null,ajaxSetup();var e=ej.Query().from("userMentionList").select("Name","Type");$("#autocomplete-input").ejAutocomplete({allowSorting:!1,dataSource:dataManger,width:"200px",popupHeight:"135px",filterType:"contains",query:e,fields:{text:"Name",key:"Type"},select:"onSelect",create:"displaySuggestionList",actionSuccess:"displaySuggestionList",open:"displaySuggestionList"});var t=void 0!==$("#itemType").attr("data-item-type")?$("#itemType").attr("data-item-type").toLowerCase():"report",a=parent.$("#dashboard_Comment").attr("data-item-id"),n=parent.$("#dashboard_Comment").attr("data-category-name"),o=parent.$("#dashboard_Comment").attr("data-item-name");parentDashboardId=parent.$("#isMultiDashboard").attr("data-parent-id");var i=renderMde("#rte-post");function s(e){if(e){var a="<li id='comment-"+e.Comments[0].Id+"'data-comment-id='"+e.Comments[0].Id+"' class='post'><div class='post-content'><div class='avatar-container'> <div class='user' data-userid='"+e.Comments[0].UserId+"'><div class='profile-pic-tag avatar' data-id='"+e.Comments[0].IdPReferenceId+"' data-type='user' data-display-name='"+e.Comments[0].UserDisplayName+"' data-image-size='32'  data-bs-toggle='tooltip' title='"+e.Comments[0].UserDisplayName+"' data-bs-placement='bottom'></div> </div></div><div class='post-body'> <header><span class='post-byline col-5 no-padding'><span title='"+e.Comments[0].UserDisplayName+"'class='author publisher-anchor-color'>"+e.Comments[0].UserDisplayName+"</span><span class='su su-status-active'></span></span><menu><li class='reply' title='"+window.Server.App.LocalizationContent.ReplyButton+"'  data-bs-toggle='tooltip' data-bs-placement='bottom'> <a class='reply-comment'><span class='su su-reply'></span> </a></li><span class='dropdown-toggle option-icon' title='"+window.Server.App.LocalizationContent.Action+"' data-bs-toggle='dropdown'><span class='su su-options-horizontal'></span></span><ul class='dropdown-menu' role='menu'><li class='edit' title='"+window.Server.App.LocalizationContent.EditButton+"'   data-bs-toggle='tooltip' data-bs-placement='top'> <a class='edit-comment'><span>"+window.Server.App.LocalizationContent.EditButton+"</span> </a></li><li class='delete' title='"+window.Server.App.LocalizationContent.Delete+"'   data-bs-toggle='tooltip' data-bs-placement='top'> <a class='delete-comment'><span>"+window.Server.App.LocalizationContent.Delete+"</span> </a></li></menu><span class='post-meta col-9 no-padding'><a "+commentPermalinkHelper(e.Comments[0].Id)+" class='permalink'><span class='time-ago' title='"+e.Comments[0].Id+"'class='permalink'><span class='time-ago' title='"+e.Comments[0].CreatedDateString+" - "+e.Comments[0].TimeZoneName+"' data-html='false'  data-bs-toggle='tooltip' data-bs-placement='right'>"+e.Comments[0].TimeAgo+"</span></a></span> </header> <div class='post-body-inner'><div class='edit-post displayNone'></div><div class='post-message'>"+SplitUserDisplayName(SanitizeHtml(customMarkdownParser(e.Comments[0].MarkdownComment)),SanitizeHtml(e.Comments[0].MarkdownComment))+"</div><div class='markDownComment d-none'>"+SanitizeHtml(e.Comments[0].MarkdownComment)+"</div></div> <div class='footer'></div></div><div class='reply-form-container displayNone'></div><div class='col-12 reply-count'><div class='col-6 child-count'><span class='count-text'>0</span><span class='count-label'> "+window.Server.App.LocalizationContent.Replies+"</span></div><div class='col-6 no-padding collapse-icon-container'><span class='su collapse-icon' data-bs-toggle='collapse' data-target=''></span></div></div></div><ul class='children'></ul> </li>";$(".sort-old").hasClass("sort-active")?$(".comment-list").append(a):$(".comment-list").prepend(a),$(".additional-content").html("");var n=parseInt($("#comment_count").text());$("#comment_count").text(n+1),$('[data-bs-toggle="tooltip"]').tooltip(),i.value(""),$("#comment_action_area").show(),$(".watch-action").hasClass("watch")&&($("#watchItem").val("Unwatch"),$("#watchItem").removeClass("watch").addClass("unwatch"),$("#watch-text").removeClass("watch").addClass("unwatch"),$("#watchItem").attr("data-original-title",window.Server.App.LocalizationContent.Unwatch)),hideWaitingPopup("parent-scroll-element"),$("#comment_action_area").removeClass("isHide"),$("#comment_action_area").show(),$("#comment_submit_container").hide(),refreshCommentScroller(),addTarget_blank(),$("#comment-"+e.Comments[0].Id).find("span.time-ago:first").click(),0==n&&"report"==t&&parent.$("#dashboard-comment").removeClass("su-without-comment").addClass("su-with-comment"),$(".post-message > p > img").on("load",function(){refreshCommentScroller()})}else hideWaitingPopup("parent-scroll-element"),parent.frames[1].messageBox("su-open",window.Server.App.LocalizationContent.AddComment,window.Server.App.LocalizationContent.AddCommentFail,"success",function(){parent.frames[1].onCloseMessageBox()});generateProfileAvatar()}function r(e){e?($("#save-edit").parentsUntil(".post").find(".post-message").html(SplitUserDisplayName(SanitizeHtml(customMarkdownParser(e.Comments[0].MarkdownComment)),SanitizeHtml(e.Comments[0].MarkdownComment))),$("#save-edit").parentsUntil(".post").find(".markDownComment").html(SanitizeHtml(e.Comments[0].MarkdownComment)),$("#save-edit").parentsUntil(".post").find(".post-message").removeClass("displayNone"),$(".watch-action").hasClass("watch")&&($("#watchItem").val("Unwatch"),$("#watchItem").removeClass("watch").addClass("unwatch"),$("#watch-text").removeClass("watch").addClass("unwatch"),$("#watchItem").attr("data-original-title",window.Server.App.LocalizationContent.Unwatch)),hideWaitingPopup($("#save-edit").parentsUntil(".post").find(".edit-post")),$(".edit-post").addClass("displayNone"),$(".edit-post").html(""),refreshCommentScroller(),addTarget_blank()):(parent.frames[1].messageBox("su-open",window.Server.App.LocalizationContent.EditComment,window.Server.App.LocalizationContent.EditCommentFail,"success",function(){parent.frames[1].onCloseMessageBox()}),hideWaitingPopup($("#save-edit").parentsUntil(".post").find(".edit-post")))}function l(e){e?(addComment="<li id='comment-"+e.Comments[0].Id+"'data-comment-id='"+e.Comments[0].Id+"' class='post'><div class='post-content'><div class='avatar-container'> <div class='user' data-userid='"+e.Comments[0].UserId+"'><div class='profile-pic-tag avatar' data-id='"+e.Comments[0].IdPReferenceId+"' data-type='user' data-display-name='"+e.Comments[0].UserDisplayName+"' data-image-size='32'  data-bs-toggle='tooltip' title='"+e.Comments[0].UserDisplayName+"' data-bs-placement='bottom'></div></div></div><div class='post-body'> <header><span class='post-byline col-5 no-padding'><span title='"+e.Comments[0].UserDisplayName+"'class='author publisher-anchor-color'>"+e.Comments[0].UserDisplayName+"</span><span class='su su-status-active'></span></span><menu>",addComment+="<li class='reply' title='"+window.Server.App.LocalizationContent.ReplyButton+"' data-bs-toggle='tooltip' data-bs-placement='bottom'> <a class='reply-comment'><span class='su su-reply'></span> </a></li><span class='dropdown-toggle option-icon' title='"+window.Server.App.LocalizationContent.Action+"' data-bs-toggle='dropdown'><span class='su su-options-horizontal'></span></span><ul class='dropdown-menu' role='menu'><li class='edit' title='"+window.Server.App.LocalizationContent.EditButton+"'   data-bs-toggle='tooltip' data-bs-placement='top'> <a class='edit-comment'><span>"+window.Server.App.LocalizationContent.EditButton+"</span> </a></li><li class='delete' title='"+window.Server.App.LocalizationContent.Delete+"'   data-bs-toggle='tooltip' data-bs-placement='top'> <a class='delete-comment'><span>"+window.Server.App.LocalizationContent.Delete+"</span> </a></li><li class='parent' data-parent-id='"+e.Comments[0].ParentId+"' title='"+window.Server.App.LocalizationContent.Replied+" "+$("#replyComment").parents(".post").find(".author").attr("title")+"'> <a class='parent-name'><span>"+window.Server.App.LocalizationContent.ShowParent+"</span> </a></li></ul></menu><span class='post-meta col-9 no-padding'><a "+commentPermalinkHelper(e.Comments[0].Id)+" class='permalink'><span class='time-ago' title='"+e.Comments[0].Id+"'class='permalink'><span class='time-ago' title='"+e.Comments[0].CreatedDateString+" - "+e.Comments[0].TimeZoneName+"'data-html='false'  data-bs-toggle='tooltip' data-bs-placement='right'>"+e.Comments[0].TimeAgo+"</span></a></span> </header> <div class='post-body-inner'><div class='edit-post displayNone'></div><div class='post-message'>"+SplitUserDisplayName(SanitizeHtml(customMarkdownParser(e.Comments[0].MarkdownComment)),SanitizeHtml(e.Comments[0].MarkdownComment))+"</div><div class='markDownComment d-none'>"+SanitizeHtml(e.Comments[0].MarkdownComment)+"</div> </div> <div class='footer'></div></div><div class='reply-form-container displayNone'></div><div class='col-12 reply-count'><div class='col-6 child-count'><span class='count-text'>0</span><span class='count-label'> "+window.Server.App.LocalizationContent.Replies+"</span></div><div class='col-6 no-padding collapse-icon-container'><span class='su collapse-icon' data-bs-toggle='collapse' data-target=''></span></div></div></div><ul class='children'></ul> </li>",$("#post-reply").closest(".post-content").siblings().prepend(addComment),$(".reply-form-container").html(""),$("#replyComment").addClass("displayNone"),$(".comment-list").find(".post").find(".post").find(".children").addClass("no-left-padding"),$("#comment_count").text(parseInt($("#comment_count").text())+1),$('[data-bs-toggle="tooltip"]').tooltip(),$("#replyComment").parent().find(".count-text").text(parseInt($("#replyComment").parent().find(".count-text").text())+1),1==parseInt($("#replyComment").parent().find(".count-text").text())?$("#replyComment").parent().find(".count-label").text(window.Server.App.LocalizationContent.ReplyMessage):$("#replyComment").parent().find(".count-label").text(" "+window.Server.App.LocalizationContent.Replies),$("#replyComment").parent().find(".collapse-icon").addClass("su-vertical-collapse"),$("#replyComment").parent().find(".reply-count").addClass("hasChild"),$(".watch-action").hasClass("watch")&&($("#watchItem").val("Unwatch"),$("#watchItem").removeClass("watch").addClass("unwatch"),$("#watch-text").removeClass("watch").addClass("unwatch"),$("#watchItem").attr("data-original-title",window.Server.App.LocalizationContent.Unwatch)),hideWaitingPopup("replyComment"),$("#replyComment").removeClass("e-waitingpopup e-js"),$(".reply-form-container").attr("id",""),refreshCommentScroller(),addTarget_blank(),generateProfileAvatar()):($("#replyComment").addClass("displayNone"),hideWaitingPopup("replyComment"),$(".reply-form-container").attr("id",""),parent.frames[1].messageBox("su-open",window.Server.App.LocalizationContent.ReplyButton,window.Server.App.LocalizationContent.ReplyFail,"success",function(){parent.frames[1].onCloseMessageBox()}),refreshCommentScroller())}function c(e){if(e){var a=deletedCommentId;parent.messageBox("su-delete",window.Server.App.LocalizationContent.DeleteComment,window.Server.App.LocalizationContent.DeleteCommnetSuccess,"success",function(){""==$("#"+a).find(".children").html()||1==$("#"+a).find(".user").length?$("#"+a).html(""):($("#"+a).find(".avatar-container:first").html("<img src='"+avatarUrl+"' class='avatar'>"),$("#"+a).find(".post-body:first").html("<header><span class='post-byline col-5 no-padding'></span><span class='post-meta col-9 no-padding'></span><menu class='deleted-post'><li class='reply' > <span class='su su-reply'></span> </li><span class='dropdown-toggle option-icon' ><span class='su su-options-horizontal'></span></span></menu> </header> <div class='post-body-inner'><div class='post-message deleted-message'><span class='su su-warning'></span><span>"+window.Server.App.LocalizationContent.DeletedMessage+"</span></div> </div>")),0==$("#"+a).parents(".post:first").find(".post-content").find(".user").length&&$("#"+a).parents(".post:first").html(""),parent.onCloseMessageBox();var e=parseInt($("#comment_count").text());$("#comment_count").text(e-1);var n=parseInt($("#"+a).parents(".post:first").find(".count-text:first").html());1==n&&($("#"+a).parents(".post:first").find(".collapse-icon:first").removeClass("su-vertical-collapse"),$("#"+a).parents(".post:first").find(".reply-count:first").removeClass("hasChild")),2==n&&$("#"+a).parents(".post:first").find(".count-label:first").html(window.Server.App.LocalizationContent.ReplyMessage),$("#"+a).parents(".post:first").find(".count-text:first").html(n-1),refreshCommentScroller(),1==e&&"report"==t&&(parent.$("#dashboard-comment").removeClass("su-with-comment").addClass("su-without-comment"),$(".additional-content").html("<h7>"+window.Server.App.LocalizationContent.NoComments+"</h7>"))})}else parent.messageBox("su-delete",window.Server.App.LocalizationContent.DeleteComment,window.Server.App.LocalizationContent.DeleteCommentFail,"success",function(){parent.onCloseMessageBox()});$("#messageBox_wrapper").ejWaitingPopup("hide")}function p(e){e?($("#watchItem").val("Unwatch"),$("#watchItem").removeClass("watch").addClass("unwatch"),$("#watch-text").removeClass("watch").addClass("unwatch"),$("#watchItem").attr("data-original-title",window.Server.App.LocalizationContent.Unwatch)):parent.frames[1].messageBox("su-eye",window.Server.App.LocalizationContent.AddWatch,window.Server.App.LocalizationContent.WatchFail,"success",function(){parent.frames[1].onCloseMessageBox()}),$(".watch-action").removeClass("disable-post")}function d(e){e?($("#watchItem").val("Watch"),$("#watchItem").removeClass("unwatch").addClass("watch"),$("#watch-text").removeClass("unwatch").addClass("watch"),$("#watchItem").attr("data-original-title",window.Server.App.LocalizationContent.Watch)):parent.frames[1].messageBox("su-eye",window.Server.App.LocalizationContent.Unwatch,window.Server.App.LocalizationContent.UnWatchFail,"success",function(){parent.frames[1].onCloseMessageBox()}),$(".watch-action").removeClass("disable-post")}cursorPos=i,$("#comment_action_slider").click(function(){cursorPos=i.value(""),i.isPreviewActive()&&i.togglePreview(),$(".reply-form-container").html(""),$(".reply-form-container").addClass("displayNone"),$(".reply-form-container").attr("id",""),$(".edit-post").addClass("displayNone"),$(".post-message").removeClass("displayNone"),$(".edit-post").html(""),$("#comment_action_area").hide(),$("#comment_submit_container").show(),$("#comment_action_area").addClass("isHide"),$(".error-message").html(""),refreshCommentScroller(),setTimeout(function(){cursorPos.codemirror.focus(),cursorPos.codemirror.setCursor({line:0,ch:0})},500)}),$("#comment_submit_container > .CodeMirror").on("keypress","textarea",function(e){i.value().length>=4e3?e.preventDefault():userMentionInitializing(e,elementNode=$("#comment_submit_container > .CodeMirror"))}),$(document).on("click",".header-comment-close",function(){i.value(""),$("#comment_action_area").removeClass("isHide"),$("#comment_action_area").show(),$("#comment_submit_container").hide(),refreshCommentScroller()}),$(".sort-new").click(function(){GetAllComments(itemId,t,a,"1"),$(".sort-new").addClass("sort-active"),$(".sort-new").removeClass("sort-inactive"),$(".sort-old").addClass("sort-inactive"),$(".sort-old").removeClass("sort-active")}),$(".sort-old").click(function(){GetAllComments(itemId,t,a,"0"),$(".sort-new").addClass("sort-inactive"),$(".sort-new").removeClass("sort-active"),$(".sort-old").addClass("sort-active"),$(".sort-old").removeClass("sort-inactive")}),$(document).on("focus","textarea",function(){$("textarea").pastableTextarea()}),$(document).on("click","#post-comment",function(){var e=splitUserMention($("#comment_submit_container > .CodeMirror")),r=truncateUrl(),l=r.split("?"),c="";l.length>1&&(c=l[1]);var p=r.split("/");"report"==t.toLowerCase()&&(r=""!=c?"/"+p[1]+"/"+a+"/"+n+"/"+o+"?"+c:"/"+p[1]+"/"+a+"/"+n+"/"+o);var d=i.value();d=EscapeHtml(d=SanitizeHtml(d));var m=i.options.previewRender(d).replace("#",""),u=(d=getRelativePath(d)).replace("http://","").replace("https://","").replace("(","").replace(")","").replace("![]","");if(isEmptyOrWhitespace(m.replace(/<[^>]*>!/gi,""))||isEmptyOrWhitespace(u))$(".error-message").html("<span class='validate-fail'>"+window.Server.App.LocalizationContent.CommentValidator+"</span>");else if(d.length>4e3)$(".error-message").html("<span class='validate-fail'>"+window.Server.App.LocalizationContent.CommnetLengthValidator+"</span>");else{$(".comment-area").val(""),$(".error-message").html("");var h={itemId:itemId,comment:d,itemType:t,dashboardItemId:a,url:decodeURI(r),uniqueUsersValue:e.uniqueUsersValue,uniqueGroupValue:e.uniqueGroupValue,mentionedAll:e.mentionedAll,parentDashboardId:parentDashboardId,CommentAction:commentAction.Add,currentDate:date};showWaitingPopup("parent-scroll-element"),parent.ajaxPostCall("POST",addCommentUrl,h,null,s,null,null)}}),$(document).on("click",".edit-comment",function(){i.value("");var e=$(this).parents("menu").siblings(".post-meta").find("a.permalink"),s=$(e).attr("href").split("comment-")[1];void 0===s&&(s=$(e).attr("href").split("comment=")[1]),$(e).attr("href","#comment-"+s),$(e).attr("target","");var l=$(this).parents(".post").attr("data-comment-id");$("#comment_action_area").removeClass("isHide"),$("#comment_action_area").show(),$("#comment_submit_container").hide(),$(".reply-form-container").html(""),$(".reply-form-container").addClass("displayNone"),$(".reply-form-container").attr("id",""),$(".edit-post").addClass("displayNone"),$(".post-message").removeClass("displayNone"),$(".edit-post").html(""),$(this).closest("div").find(".edit-post").html("<div class='edit'><textarea id='edit_comment_"+l+"' class='form-control edit-text' placeholder='' style='overflow: hidden;'></textarea><span class='message'>*"+window.Server.App.LocalizationContent.CommentWords+"</span><span class='error-message-edit'></span><div class='temp-post'><button class='edit-cancel secondary-button app-btn-secondary float-end'>"+window.Server.App.LocalizationContent.CancelButton+"</button><button id ='save-edit' class='primary-button app-btn-primary "+tailwindClassName+" float-end' type='submit'>"+window.Server.App.LocalizationContent.SaveButton+"</button></div></div>");var c=renderMde("#edit_comment_"+l);cursorPos=c,$(this).closest("div").find(".post-message").addClass("displayNone"),$(this).closest("div").find(".edit-post").removeClass("displayNone"),refreshCommentScroller(),$(e).find("span.time-ago").click();var p=$(this).closest("div").find(".markDownComment").text(),d=p.match(/(?:\!\[\]\((.*?)\))/g),m=[];if(null!=d){for(var u=0;u<d.length;u++)m[u]=d[u].split(/[\(\\!\[\ \]\\)\s]+/),m[u]=$.grep(m[u],function(e){return e});for(var h=0;h<m.length;h++)if(m[h]=m[h].toString(),-1!==m[h].indexOf("image-"))for(var g=m[h].split("/"),f=0;f<g.length;f++)-1!==g[f].indexOf("image-")&&(p=p.replace(m[h],g[f]))}c.value(p),setTimeout(function(){cursorPos.codemirror.focus()},200),cursorPos.codemirror.setCursor({line:p.length,ch:p.length}),"false"==parent.$("#is_mobile").val()&&$("#save-edit").prop("disabled","true");var v=$(this).closest("div").find(".markDownComment").text();$(".CodeMirror").on("keypress keyup","textarea",function(e){var t=c.value();t.length>=4e3?e.preventDefault():userMentionInitializing(e,elementNode=$("#edit_comment_"+l).parent()),v!=t.trim()?$("#save-edit").removeAttr("disabled"):$("#save-edit").prop("disabled","true")}),$(".editor-toolbar").on("click",function(e){$("textarea").keypress()}),$("#save-edit").on("click",function(){var e=truncateUrl(),i=e.split("?"),s="";i.length>1&&(s=i[1]);var l=e.split("/");"report"==t.toLowerCase()&&(e=""!=s?"/"+l[1]+"/"+a+"/"+n+"/"+o+"?"+s:"/"+l[1]+"/"+a+"/"+n+"/"+o);var p=c.value();p=getRelativePath(p=EscapeHtml(p=SanitizeHtml(p)));var d=$(this).closest(".post").attr("data-comment-id"),m=splitUserMention($("#edit_comment_"+d).parent()),u={itemId:itemId,comment:p,commentId:d,itemType:t,dashboardItemId:a,url:decodeURI(e),uniqueUsersValue:m.uniqueUsersValue,uniqueGroupValue:m.uniqueGroupValue,mentionedAll:m.mentionedAll,commentAction:commentAction.Edit,parentDashboardId:parentDashboardId,currentDate:date},h=c.options.previewRender(p).replace("#",""),g=p.replace("http://","").replace("https://","").replace("(","").replace(")","").replace("![]","");return isEmptyOrWhitespace(h.replace(/<[^>]*>!/gi,""))||isEmptyOrWhitespace(g)?($(".edit-text").addClass("inactive-box"),void $(".error-message-edit").html("<span class='validate-fail'>"+window.Server.App.LocalizationContent.CommentValidator+"</span>")):p.length>4e3?($(".reply-text").addClass("inactive-box"),void $(".error-message-edit").html("<span class='validate-fail'>"+window.Server.App.LocalizationContent.CommnetLengthValidator+"</span>")):(showWaitingPopup($("#save-edit").parentsUntil(".post").find(".edit-post")),void parent.ajaxPostCall("POST",editCommentUrl,u,null,r,null,null))}),$(".edit-cancel").on("click",function(){$(".post-message").removeClass("displayNone"),$(".edit-post").addClass("displayNone"),$(".edit-post").html(""),$(".error-message-edit").html(""),refreshCommentScroller()})}),$(document).on("click",".reply-comment",function(){i.value("");var e=$(this).parents("menu").siblings(".post-meta").find("a.permalink"),s=$(e).attr("href").split("comment-")[1];void 0===s&&(s=$(e).attr("href").split("comment=")[1]),$(e).attr("href","#comment-"+s),$(e).attr("target","");var r=$(this).parents(".post").attr("data-comment-id");$("#comment_action_area").removeClass("isHide"),$("#comment_action_area").show(),$("#comment_submit_container").hide(),$(".post-message").removeClass("displayNone"),$(".edit-post").addClass("displayNone"),$(".edit-post").html(""),$(".reply-form-container").html(""),$(".reply-form-container").addClass("displayNone"),$(".reply-form-container").attr("id",""),$(this).closest("div").parent().parent().find(".reply-form-container").html("<textarea id='replyto_comment_"+r+"' class='form-control reply-text' maxlength='4000' style='overflow: hidden;'></textarea><span class='message'>*"+window.Server.App.LocalizationContent.CommentWords+"</span><div class='reply-comment-footer'><span class='error-message-reply'></span><button class='reply-cancel secondary-button app-btn-secondary float-end'>"+window.Server.App.LocalizationContent.CancelButton+"</button><input id='post-reply' class='primary-button app-btn-primary float-end' value='"+window.Server.App.LocalizationContent.ReplyButton+"' type='submit'></div>");var c=renderMde("#replyto_comment_"+r);cursorPos=c,$(this).closest("div").parent().parent().find(".reply-form-container").attr("id","replyComment"),$("#replyComment").removeClass("displayNone"),refreshCommentScroller(),$(e).find("span.time-ago").click(),setTimeout(function(){cursorPos.codemirror.focus()},200),cursorPos.codemirror.setCursor({line:0,ch:0}),$("#replyComment > .CodeMirror").on("keypress","textarea",function(e){c.value().length>=4e3?e.preventDefault():userMentionInitializing(e,elementNode=$("#replyComment > .CodeMirror"))}),$("#post-reply").on("click",function(){var e=truncateUrl(),i=e.split("?"),s="";i.length>1&&(s=i[1]);var r=e.split("/");"report"==t.toLowerCase()&&(e=""!==s?"/"+r[1]+"/"+a+"/"+n+"/"+o+"?"+s:"/"+r[1]+"/"+a+"/"+n+"/"+o);var p=c.value();p=EscapeHtml(p=SanitizeHtml(p));var d=splitUserMention($("#replyComment > .CodeMirror"));p=getRelativePath(p);var m=$(this).closest(".post").attr("data-comment-id"),u={itemId:itemId,comment:p,parentId:m,itemType:t,dashboardItemId:a,url:decodeURI(e),uniqueUsersValue:d.uniqueUsersValue,uniqueGroupValue:d.uniqueGroupValue,mentionedAll:d.mentionedAll,parentDashboardId:parentDashboardId,currentDate:date},h=c.options.previewRender(p).replace("#",""),g=p.replace("http://","").replace("https://","").replace("(","").replace(")","").replace("![]","");return isEmptyOrWhitespace(h.replace(/<[^>]*>!/gi,""))||isEmptyOrWhitespace(g)?($(".reply-text").addClass("inactive-box"),void $(".error-message-reply").html("<span class='validate-fail'>"+window.Server.App.LocalizationContent.ReplyValidator+"</span>")):p.length>4e3?($(".reply-text").addClass("inactive-box"),void $(".error-message-reply").html("<span class='validate-fail'>"+window.Server.App.LocalizationContent.ReplayContenLength+"</span>")):(showWaitingPopup("replyComment"),void parent.ajaxPostCall("POST",addCommentUrl,u,null,l,null,null))}),$(".reply-cancel").on("click",function(){$("#replyComment").addClass("displayNone"),$(".reply-form-container").html(""),$(".reply-form-container").attr("id",""),$(".error-message-reply").html(""),refreshCommentScroller()})}),$(document).on("click",".delete-comment",function(){var e=truncateUrl(),i=e.split("?"),s="";i.length>1&&(s=i[1]);var r=e.split("/");"report"==t.toLowerCase()&&(e=""!==s?"/"+r[1]+"/"+a+"/"+n+"/"+o+"?"+s:"/"+r[1]+"/"+a+"/"+n+"/"+o);var l=$(this).closest(".post").attr("data-comment-id"),p=$(this).closest(".post").attr("id");deletedCommentId=p,parent.messageBox("su-delete",window.Server.App.LocalizationContent.DeleteComment,window.Server.App.LocalizationContent.DeleteComentConfirm,"error",function(){var n=parent.createLoader("messageBox_wrapper");$("#messageBox_wrapper").ejWaitingPopup({template:parent.$("#"+n)}),$("#messageBox_wrapper").ejWaitingPopup("show");var o={itemId:itemId,commentId:l,itemType:t,dashboardItemId:a,url:decodeURI(e),commentAction:commentAction.Delete,currentDate:date};parent.ajaxPostCall("POST",deleteCommentUrl,o,null,c,null,null)})}),$(document).on("click",".watch-action",function(){if(!$(this).hasClass("disable-post"))if($(".watch-action").addClass("disable-post"),$(this).hasClass("watch")){var e={itemId:itemId,isWatch:!0,currentDate:date};parent.ajaxPostCall("POST",watchUrl,e,null,p,null,null)}else{e={itemId:itemId,isWatch:!1,currentDate:date};parent.ajaxPostCall("POST",unWatchUrl,e,null,d,null,null)}}),$(document).on("click",".parent",function(){var e="#comment-"+$(this).attr("data-parent-id"),t=$(e).find(".permalink:first").attr("href").split("comment-")[1];if(void 0===t&&(t=$(e).find(".permalink:first").attr("href").split("comment=")[1]),$(e).find(".permalink:first").attr("href","#comment-"+t),$(e).find(".permalink:first").attr("target",""),$(e).isOnScreen()||$(e).find(".time-ago:first").click(),$(e).find(".post-content:first").css({"background-color":"#F4E4AE"}),i_am_ie9){$(e).find(".post-content:first").css("backgroundColor","hsl(46,76%,82%");for(var a=3e3,n=82;n<=100;n+=.1)(function(t,a){setTimeout(function(){$(e).find(".post-content:first").css("backgroundColor","hsl(46,76%,"+t+"%)")},a)})(n,a+=10)}else setTimeout(function(){$(e).find(".post-content:first").css({transition:"background-color 5s ease-in-out","background-color":"inherit"})},20),setTimeout(function(){$(e).find(".post-content:first").attr("style","")},4e3)}),$(document).on("mousedown",".permalink",function(e){if(postId=$(this).attr("href").split("comment-")[1],"undefined"==typeof postId&&(postId=$(this).attr("href").split("comment=")[1]),2==e.which||3==e.which){var t=parent.document.URL;-1!=parent.window.location.href.indexOf("?comment")||-1==parent.window.location.href.indexOf("?")?(t=t.split("?comment=")[0],$(this).attr("href",t+"?comment="+postId)):(t=t.split("&comment=")[0],$(this).attr("href",t+"&comment="+postId)),$(this).attr("target","_blank")}1==e.which&&($(this).attr("href","#comment-"+postId),$(this).attr("target",""))}),$(document).on("click",".hasChild",function(){$(this).find(".collapse-icon").hasClass("su-vertical-expand")?($(this).find(".collapse-icon").parents(".post-content").siblings("ul.children").slideDown("slow",function(){refreshCommentScroller()}),$(this).find(".collapse-icon").addClass("su-vertical-collapse"),$(this).find(".collapse-icon").removeClass("su-vertical-expand"),$(this).find(".collapse-icon").parents(".reply-count").removeClass("expanded"),$(this).find(".collapse-icon").attr("title","Collapse")):($(this).find(".collapse-icon").parents(".post-content").siblings("ul.children").slideUp("slow",function(){refreshCommentScroller()}),$(this).find(".collapse-icon").addClass("su-vertical-expand"),$(this).find(".collapse-icon").removeClass("su-vertical-collapse"),$(this).find(".collapse-icon").parents(".reply-count").addClass("expanded"),$(this).find(".collapse-icon").attr("title","Expand"))}),$(document).on("mouseover","#comment-image-file,#comment-image-edit-file",function(){var e,t=$.now(),a=$("#itemType").attr("data-item-type").toLowerCase().replace(/\b[a-z]/g,function(e){return e.toUpperCase()});$("#comment-image-file,#comment-image-edit-file").ejUploadbox({saveUrl:fileUploadUrl+"?imageType=commentimage&&timeStamp="+t+"&&itemId="+itemId+"&&itemType="+a,autoUpload:!0,showFileDetails:!1,multipleFilesSelection:!1,buttonText:{browse:""},width:"29px",height:"29px",showBrowseButton:!1,extensionsAllow:".PNG,.png,.jpg,.JPG,.jpeg,.JPEG",beforeSend:function(e){setXSRFRequestHeader(e.xhr)},begin:function(){showWaitingPopup("parent-scroll-element")},fileSelect:function(t){$(".confirmatioMessage").hide(),e=t.files[0].extension.toLowerCase(),t.files[0].name},error:function(t){".png"==e||".jpg"==e||".jpeg"==e||$(".error-message").html("<span class='validate-fail'>"+window.Server.App.LocalizationContent.FileFormatNotsupport+"</span>")},complete:function(e){if(""!=e.responseText&&-1!==e.responseText.indexOf("image-")){var t=" ![]("+e.responseText.split(";")[1]+")";$("textarea").focus(),cursorPos.codemirror.replaceSelection(t),hideWaitingPopup("parent-scroll-element"),$("textarea").keypress()}}}),$("#comment-image-file_SelectButton,#comment-image-file,#comment-image-edit-file,.e-uploadinput").attr("title",window.Server.App.LocalizationContent.UploadImage)}),parent.$("#commentImage_popup").ejDialog({showOnInit:!1,allowDraggable:!1,enableResize:!1,showHeader:!1,enableModal:!0,close:"commentImageDialogClose",closeOnEscape:!0}),$(document).on("click",".post-message > p > img",function(){var e;e=$(window).height();var t,a,n,o,i=null==parent.$(dashboardTypeId).width()?parent.$("#widget").width():parent.$(dashboardTypeId).width(),s=$(this).attr("src"),r=new Image;r.src=s,$(r).on("load",function(){t=r.width,a=r.height,e>a?(n=e-a>40?a:a=e-.07*e,parent.$("#commentImage_popup_wrapper").css({height:n}),parent.$("#commentImage_popup_image,#commentImage_popup,#PopupContainer,#commentImage_popup_wrapper .e-dialog-scroller").css({height:a})):(a=null!==parent.$("#widget").height()?a-(a-e+40):a-(a-e+20),n=a,parent.$("#commentImage_popup_wrapper").css({height:n}),parent.$("#commentImage_popup_image,#commentImage_popup,#PopupContainer,#commentImage_popup_wrapper .e-dialog-scroller").css({height:a})),i>=t&&t<=900?(o=i-t>40?t:t=i-.07*i,parent.$("#commentImage_popup_wrapper").css({width:o}),parent.$("#commentImage_popup_image,#commentImage_popup,#PopupContainer,#commentImage_popup_wrapper .e-dialog-scroller").css({width:t})):(o=t=.68*i,parent.$("#commentImage_popup_wrapper").css({width:o}),parent.$("#commentImage_popup_image,#commentImage_popup,#PopupContainer,#commentImage_popup_wrapper .e-dialog-scroller").css({width:t})),parent.$("#commentImage_popup_image").attr("src",s),parent.$("#commentImage_popup").removeClass("hidden"),parent.$("#commentImage_popup").ejDialog("open")})}),$(window).resize(function(){refreshCommentScroller()}),$(document).on("click",".prevent-default-action",function(e){e.preventDefault()})}),$.fn.isOnScreen=function(){windowHeight=$("#list_container").outerHeight(),$("#comment_action_area").hasClass("isHide")?textAreaHeight=$("#comment_submit_container").outerHeight():textAreaHeight=$("#comment_action_area").outerHeight();var e=textAreaHeight+$(".count-sort").outerHeight();return offsetTop=this.offset().top,offsetTop>=e&&offsetTop<=windowHeight},$.fn.pastableTextarea=function(){var e,t,a;for(t=0,a=this.length;t<a;t++)(e=this[t])._pastable||$(e).is(":not(textarea, input:text)")||(Paste.mountTextarea(e),e._pastable=!0);return this},createHiddenEditable=function(){return $(document.createElement("div")).attr("contenteditable",!0).attr("aria-hidden",!0).attr("tabindex",-1).css({width:1,height:1,position:"fixed",left:-100,overflow:"hidden"})},isFocusable=function(e,t){var a,n,o,i,s,r;return i=void 0,s=void 0,o=void 0,n=void 0,a=void 0,"area"===(r=e.nodeName.toLowerCase())?(s=(i=e.parentNode).name,!(!e.href||!s||"map"!==i.nodeName.toLowerCase())&&((o=$("img[usemap='#"+s+"']")).length>0&&o.is(":visible"))):(/^(input|select|textarea|button|object)$/.test(r)?(n=!e.disabled)&&(a=$(e).closest("fieldset")[0])&&(n=!a.disabled):n="a"===r&&e.href||t,(n=n||$(e).is("[contenteditable]"))&&$(e).is(":visible"))},Paste=function(){function e(e,t){var a;this._container=e,this._target=t,this._container=$(this._container),this._target=$(this._target).addClass("pastable"),this._container.on("paste",(a=this,function(e){var t,n,o,i,s,r,l,c,p,d,m,u,h;if(showWaitingPopup("parent-scroll-element"),a._paste_event_fired=!0,null!=(null!=(p=e.originalEvent)?p.clipboardData:void 0))if((t=e.originalEvent.clipboardData).items)for(i=0,r=(d=t.items).length;i<r;i++){if((o=d[i]).type.match(/^image\//)){(c=new FileReader).onload=function(e){return a._handleImage(e.target.result)},c.readAsDataURL(o.getAsFile()),e.preventDefault();break}"text/plain"===o.type&&o.getAsString(function(e){setTimeout(function(){return hideWaitingPopup("parent-scroll-element"),a._target.trigger("pasteText",{text:e})},1)})}else-1!==Array.prototype.indexOf.call(t.types,"text/plain")&&(h=t.getData("Text"),setTimeout(function(){return hideWaitingPopup("parent-scroll-element"),a._target.trigger("pasteText",{text:h})},1)),a._checkImagesInContainer(function(e){return a._handleImage(e)});if(t=window.clipboardData)if(null!=(m=h=t.getData("Text"))?m.length:void 0)setTimeout(function(){return hideWaitingPopup("parent-scroll-element"),a._target.trigger("pasteText",{text:h}),a._target.trigger("_pasteCheckContainerDone")},1);else{for(s=0,l=(u=t.files).length;s<l;s++)n=u[s],a._handleImage(URL.createObjectURL(n));a._checkImagesInContainer(function(e){})}return setTimeout(function(){hideWaitingPopup("parent-scroll-element")},1e3),null}))}return e.prototype._target=null,e.prototype._container=null,e.mountNonInputable=function(t){var a;return a=new e(createHiddenEditable().appendTo(t),t),$(t).on("click",function(e){if(!isFocusable(e.target,!1))return a._container.focus()}),a._container.on("focus",function(){return $(t).addClass("pastable-focus")}),a._container.on("blur",function(){return $(t).removeClass("pastable-focus")})},e.mountTextarea=function(t){var a,n;return DataTransfer.prototype.__lookupGetter__("items")?this.mountContenteditable(t):(n=new e(createHiddenEditable().insertBefore(t),t),a=!1,$(t).on("keyup",function(e){var t;return 17!==(t=e.keyCode)&&224!==t||(a=!1),null}),$(t).on("keydown",function(e){var o;return 17!==(o=e.keyCode)&&224!==o||(a=!0),null!=e.ctrlKey&&null!=e.metaKey&&(a=e.ctrlKey||e.metaKey),a&&86===e.keyCode&&(n._textarea_focus_stolen=!0,n._container.focus(),n._paste_event_fired=!1,setTimeout(function(){if(!n._paste_event_fired)return $(t).focus(),n._textarea_focus_stolen=!1},1)),null}),$(t).on("paste",function(){}),$(t).on("focus",function(){if(!n._textarea_focus_stolen)return $(t).addClass("pastable-focus")}),$(t).on("blur",function(){if(!n._textarea_focus_stolen)return $(t).removeClass("pastable-focus")}),$(n._target).on("_pasteCheckContainerDone",function(){return $(t).focus(),n._textarea_focus_stolen=!1}),$(n._target).on("pasteText",function(e,a){var n=a.text;return cursorPos.codemirror.replaceSelection(n),hideWaitingPopup("parent-scroll-element"),$(t).trigger("change")}))},e.mountContenteditable=function(t){return new e(t,t),$(t).on("focus",(hideWaitingPopup("parent-scroll-element"),function(){return $(t).addClass("pastable-focus")})),$(t).on("blur",function(){return hideWaitingPopup("parent-scroll-element"),$(t).removeClass("pastable-focus")})},e.prototype._handleImage=function(e){var t;return(t=new Image).crossOrigin="anonymous",t.onload=function(){var e;(e=document.createElement("canvas")).width=t.width,e.height=t.height,e.getContext("2d").drawImage(t,0,0,e.width,e.height);try{pasteImageReader(e.toDataURL("image/png"))}catch(e){hideWaitingPopup("parent-scroll-element")}},t.onerror=void 0,t.src=e},e.prototype._checkImagesInContainer=function(e){var t,a,n,o,i,s;for(i=Math.floor(1e3*Math.random()),a=0,n=(o=this._container.find("img")).length;a<n;a++)(t=o[a])["_paste_marked_"+i]=!0;return setTimeout((s=this,function(){var a,n,o;for(0==(o=s._container.find("img")).length&&hideWaitingPopup("parent-scroll-element"),a=0,n=o.length;a<n;a++)(t=o[a])["_paste_marked_"+i]||(e(t.src),$(t).remove());return s._target.trigger("_pasteCheckContainerDone")}),1)},e}(),$(document).on("click","#close-comment",function(){parent.isViewerV2Enabled?parent.$("#sync_report_viewer_toolbar_comments").trigger("click"):closeComments()}),$.ajaxSetup({beforeSend:function(e){setXSRFRequestHeader(e)}});
